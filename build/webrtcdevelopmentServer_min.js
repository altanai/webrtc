exports.redisscipts=function(){const a=require("redis"),b=require("redis-server");return module.startServer=function(){const a=process.env.REDIS_PORT||6379,c=new b(a);c.open(a=>{null===a&&(console.log("----------------Redis----------------------"),console.log("[Redis] Redis server started"))})},module.startclient=function(){const b=a.createClient();return b.on("error",function(a){console.error(a)}),b.set("key","value",a.print),b.get("key",a.print),b},module};
exports.realtimecomm=function(a,b,c){async function d(a){try{var b=e[a.userid],d={};b&&b.extra&&(d=b.extra);let f={socket:a,connectedWith:{},isPublic:!1,extra:d||{}};if(c){const b=await c.hset(a.userid,"data",f);console.log(b)}else e[a.userid]=f}catch(a){console.error(a)}}var e={},f={},g={},h=[],k={};console.log("[RealtimeComm] ----------------realtimecomm----------------------"),console.log("[RealtimeComm] env => "+a.enviornment+" running at "+a.wssPort);const l=require("https").createServer(b,(a,b)=>{console.log("req"),b.writeHeader(200,{"Content-Type":"text/plain"}),b.write("test"),b.end()}),m=require("socket.io")(l,{path:"/",serveClient:!1,pingInterval:1e4,pingTimeout:5e3,cookie:!1});return m.on("connection",function(a){function b(b){try{if(!e[b.sender])return void a.emit("user-not-found",b.sender);b.message.userLeft||e[b.sender].connectedWith[b.remoteUserId]||!e[b.remoteUserId]||(e[b.sender].connectedWith[b.remoteUserId]=e[b.remoteUserId].socket,e[b.sender].socket.emit("user-connected",b.remoteUserId),!e[b.remoteUserId]&&(e[b.remoteUserId]={socket:null,connectedWith:{},isPublic:!1,extra:{}}),e[b.remoteUserId].connectedWith[b.sender]=a,e[b.remoteUserId].socket&&e[b.remoteUserId].socket.emit("user-connected",b.sender)),e[b.sender].connectedWith[b.remoteUserId]&&e[a.userid]&&(b.extra=e[a.userid].extra,e[b.sender].connectedWith[b.remoteUserId].emit(k,b))}catch(a){console.error("onMessageCallback",a)}}let c=a.handshake.query;var k=c.msgEvent||"RTCMultiConnection-Message";a.userid=c.userid,d(a),a.on("ping-webrtcdev",()=>{console.log(" sending pong for ping"),a.emit("pong-webrtcdev")}),a.on("extra-data-updated",function(b){try{if(!e[a.userid])return;for(var c in e[a.userid].extra=b,e[a.userid].connectedWith)e[c].socket.emit("extra-data-updated",a.userid,b)}catch(a){console.error("extra-data-updated",a)}}),a.on("changed-uuid",function(b,f){if(f=f||function(){},c.dontUpdateUserId)return void delete c.dontUpdateUserId;try{if(e[a.userid]&&e[a.userid].socket.id==a.userid){if(b===a.userid)return;var g=a.userid;return e[b]=e[g],e[b].socket.userid=a.userid=b,delete e[g],void f()}a.userid=b,d(a),f()}catch(a){console.error("changed-uuid",a)}}),a.on("set-password",function(b){try{e[a.userid]&&(e[a.userid].password=b)}catch(a){console.error("set-password",a)}}),a.on("disconnect-with",function(b,c){try{if(e[a.userid]&&e[a.userid].connectedWith[b]&&(delete e[a.userid].connectedWith[b],a.emit("user-disconnected",b)),!e[b])return c();e[b].connectedWith[a.userid]&&(delete e[b].connectedWith[a.userid],e[b].socket.emit("user-disconnected",a.userid)),c()}catch(a){console.error("disconnect-with",a)}}),a.on("close-entire-session",function(b){try{var c=e[a.userid].connectedWith;Object.keys(c).forEach(function(b){if(c[b]&&c[b].emit)try{c[b].emit("closed-entire-session",a.userid,e[a.userid].extra)}catch(a){}}),delete f[a.userid],b()}catch(a){console.error("close-entire-session",a)}}),a.on("check-presence",function(b,c){if(b===a.userid&&!!e[b])return void c(!1,a.userid,e[b].extra);var d={};e[b]&&(d=e[b].extra),c(!!e[b],b,d)}),a.on("open-channel",function(b){console.log("------------open channel------------- ",b.channel," by ",b.sender);var c=null;b.channel?c=b.channel:console.log(" Err :  channel is empty"),0>h.indexOf(c)?(h.push(c),console.log("registered new in channels ",h)):console.log("channel already exists channels ",h);try{g[c]={channel:c,timestamp:new Date().toLocaleString(),maxAllowed:b.maxAllowed||100,users:[b.sender],status:"waiting",endtimestamp:0,log:[new Date().toLocaleString()+":-channel created . User "+b.sender+" waiting "]},console.log("information added to channel",g)}catch(a){console.error(" Err : info couldnt be added to channel ",a)}var d={status:!0,channel:c};a.emit("open-channel-resp",d)}),a.on("open-channel-screenshare",function(b){console.log("------------open channel screenshare------------- ",b.channel," by ",b.sender);var c={status:!0,channel:b.channel};a.emit("open-channel-screenshare-resp",c)}),a.on("join-channel",function(b){var c=!1,d=b.channel;if((g[b.channel].users.length<g[b.channel].maxAllowed||"unlimited"==g[b.channel].maxAllowed)&&(c=!0),console.log("------------join channel------------- ",b.channel," by ",b.sender," isallowed ",c),c){g[b.channel].users.push(b.sender),g[b.channel].status=g[b.channel].users.length+" active members",g[b.channel].log.push(new Date().toLocaleString()+":-User "+b.sender+" joined the channel ");let c={status:!0,channel:b.channel,users:g[b.channel].users};a.emit("join-channel-resp",c);a.broadcast.emit("channel-event",{status:!0,type:"new-join",msgtype:"success",data:b})}else{console.warn(" Not aloowed to join channel , maxAllowed : ",g[b.channel].maxAllowed," current-users : ",g[b.channel].users.length);a.emit("join-channel-resp",{status:!1,msgtype:"error",msg:"Sorry cant join this channel"});var e={status:!0,type:"new-join",msgtype:"error",msg:"Another user is trying to join this channel but max count [ "+g[b.channel].maxAllowed+" ] is reached"};a.broadcast.emit("channel-event",e)}}),a.on("update-channel",function(a){switch(console.log("------------update channel------------- ",a.channel," by ",a.sender," -> ",a),a.type){case"change-userid":var b=g[a.channel].users.indexOf(a.extra.old);console.log("old userid",g[a.channel].users[b]),g[a.channel].users[b]=a.extra.new,console.log("changed userid",g[a.channel].users);break;default:console.log("do nothing ");}}),a.on("presence",function(b){var c=!!g[b.channel];console.log(" Presence Check index of ",b.channel," is ",c),a.emit("presence",c)}),a.on("admin_enquire",function(b){switch(b.ask){case"channels":b.find?a.emit("response_to_admin_enquire",module.getChannel(b.find,b.format)):a.emit("response_to_admin_enquire",module.getAllChannels(b.format));break;case"users":a.emit("response_to_admin_enquire",module.getAllActiveUsers(b.format));break;case"channel_clients":a.emit("response_to_admin_enquire",module.getChannelClients(b.channel));break;default:a.emit("response_to_admin_enquire","no case matched ");}});var l=0;a.on(k,function(c,d){if(!(c.remoteUserId&&c.remoteUserId===a.userid))try{if(c.remoteUserId&&"system"!=c.remoteUserId&&c.message.newParticipationRequest&&e[c.remoteUserId]&&e[c.remoteUserId].password){if(3<l)return void a.emit("password-max-tries-over",c.remoteUserId);if(!c.password)return l++,void a.emit("join-with-password",c.remoteUserId);if(c.password!=e[c.remoteUserId].password)return l++,void a.emit("invalid-password",c.remoteUserId,c.password)}if(c.message.shiftedModerationControl)return c.message.firedOnLeave?void(f[c.sender]=c):void b(c);if("system"==c.remoteUserId&&c.message.detectPresence)return c.message.userid===a.userid?void d(!1,a.userid):void d(!!e[c.message.userid],c.message.userid);if(e[c.sender]||(e[c.sender]={socket:a,connectedWith:{},isPublic:!1,extra:{}}),c.message.newParticipationRequest){var g=0;return void function d(){return g++,120<g?void a.emit("user-not-found",c.remoteUserId):e[c.remoteUserId]&&e[c.remoteUserId].socket?void b(c):void setTimeout(d,1e3)}()}b(c)}catch(a){console.error("on-socketMessageEvent",a)}}),a.on("disconnect",function(){console.log("[RealtimeComm] disconnect");try{a.namespace&&delete a.namespace.sockets[this.id]}catch(a){console.error("disconnect",a)}try{let c=f[a.userid];c&&(delete f[c.userid],b(c))}catch(a){console.error("disconnect",a)}try{if(e[a.userid])for(var c in e[a.userid].connectedWith)e[a.userid].connectedWith[c].emit("user-disconnected",a.userid),e[c]&&e[c].connectedWith[a.userid]&&(delete e[c].connectedWith[a.userid],e[c].socket.emit("user-disconnected",a.userid))}catch(a){console.error("disconnect",a)}delete e[a.userid]}),module.socket=m}),m.on("error",a=>{console.error(a)}),m.on("disconnect",()=>{console.error("disconnected ")}),l.listen(a.wssPort),module.getAll=function(a){let b=[];for(i in g)b.push(g[i]);return{response:"channels",channels:b,format:a}},module.getAllChannels=function(a){var b=[];for(i in Object.keys(g))b.push(Object.keys(g)[i]);return{response:"all",channelinfo:b,format:a}},module.getChannel=function(a,b){var c={response:"channel",channelinfo:g[a]?g[a]:null,format:b};return c},module.getAllActiveUsers=function(a){var b=[];for(i in Object.keys(g)){var c=Object.keys(g)[i];for(j in g[c].users)b.push(g[c].users[j])}return{response:"users",users:b,format:a}},module.getUser=function(a,b){let c={response:"users",users:k[a]?k[a]:"notfound",format:b};return c},module.getChannelClients=function(a){let b={response:"users",clients:m.of("/"+a).clients(),format:data.format};return b},module};
exports.restapi=function(a,b,c,d){var e=require("restify"),f=e.createServer(b);return f.use(function(a,b,c){return b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","X-Requested-With"),c()}),f.use(e.plugins.acceptParser(f.acceptable)),f.use(e.plugins.dateParser()),f.use(e.plugins.queryParser()),f.use(e.plugins.bodyParser({mapParams:!0})),f.get("/webrtc/details",function(a,b){console.log("params----------",a.params),b.json({type:!0,data:a.params.version})}),f.get("/session/all-sessions",function(b,c){var d=a.getAllChannels("json");c.json({type:!0,data:d})}),f.get("/session/getsession/:channelid",function(b,c){if(console.log(" [ Rest api - getSession ]  logs for ",b.params.channelid),!b.params.channelid)return void c.json({type:!0,data:"channelid is required"});var d=a.getChannel(b.params.channelid,"json");c.json({type:!0,data:d})}),f.get("/session/clients",function(b,c){var d=a.getChannelClients("json");c.json({type:!0,data:d})}),f.get("/user/all-users",function(b,c){var d=a.getAllActiveUsers("json");c.json({type:!0,data:d})}),f.get("/user/getuser/:userid",function(b,c){if(console.log(" [ Rest api - getUser ]  logs for ",b.params.userid),!b.params.userid)return void c.json({type:!0,data:"userid is required"});var d=a.getUser(b.params.userid,"json");c.json({type:!0,data:d})}),f.on("MethodNotAllowed",function(a,b){if("options"===a.method.toLowerCase()){return-1===b.methods.indexOf("OPTIONS")&&b.methods.push("OPTIONS"),b.header("Access-Control-Allow-Credentials",!0),b.header("Access-Control-Allow-Headers",["Accept","Accept-Version","Content-Type","Api-Version","Origin","X-Requested-With"].join(", ")),b.header("Access-Control-Allow-Methods",b.methods.join(", ")),b.header("Access-Control-Allow-Origin",a.headers.origin),b.send(204)}return b.send(new e.MethodNotAllowedError)}),f.listen(d.restPort,function(){console.log("%s listening at %s",f.name,f.url)}),console.log("----------------------REST APIs ----------------"),console.log(" REST server env => "+d.enviornment+" running at\n "+d.restPort),module};